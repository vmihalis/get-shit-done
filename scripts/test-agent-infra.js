#!/usr/bin/env node

/**
 * Integration test for agent infrastructure
 * Tests spawn -> wait -> verify -> collect workflow
 */

import { spawnAgent, waitForAgents } from '../src/agent-spawn.js';
import { verifyOutputs, collectOutputs, reportResults } from '../src/agent-collect.js';
import { mkdir, rm, writeFile } from 'node:fs/promises';
import { execSync } from 'node:child_process';
import { fileURLToPath } from 'node:url';
import { dirname, join } from 'node:path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');

// Test output paths
const TEST_DIR = join(projectRoot, '.planning', 'test');
const TEST_FILE = join(TEST_DIR, 'TEST.md');

/**
 * Check if Cline CLI is available
 */
function checkClineCli() {
  try {
    execSync('cline --version', { stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Run mock test without Cline CLI
 * Uses direct file operations to test verify/collect
 */
async function runMockTest() {
  console.log('\nAgent Infrastructure Test (Mock Mode)');
  console.log('=====================================');
  console.log('Note: Cline CLI not found, running with mock data\n');

  // 1. Setup
  console.log('1. Setting up test directory...');
  await mkdir(TEST_DIR, { recursive: true });

  // 2. Create mock output
  console.log('2. Creating mock agent output...');
  const mockContent = `# Test Output

Generated by mock test at ${new Date().toISOString()}

This file simulates agent output.
`;
  await writeFile(TEST_FILE, mockContent);
  console.log('   Mock output created');

  // 3. Verify outputs
  console.log('3. Verifying outputs...');
  const verifications = await verifyOutputs([TEST_FILE]);
  const { total, found, missing, report } = reportResults(verifications);
  console.log(`   ${report.split('\n').join('\n   ')}`);

  // 4. Collect content
  console.log('4. Collecting content...');
  const outputs = await collectOutputs([TEST_FILE]);
  const successful = outputs.filter((o) => o.content !== null);
  console.log(`   Collected ${successful.length} files`);

  // 5. Cleanup
  console.log('5. Cleanup...');
  await rm(TEST_DIR, { recursive: true, force: true });
  console.log('   Test directory removed');

  // Result
  console.log('\nResult: PASS (mock mode)');
  console.log('- verifyOutputs: OK');
  console.log('- collectOutputs: OK');
  console.log('- reportResults: OK');
  console.log('\nTo test with real agents, install Cline CLI: npm install -g @anthropic/cline-cli');

  return true;
}

/**
 * Run full test with Cline CLI
 */
async function runFullTest() {
  console.log('\nAgent Infrastructure Test (Full Mode)');
  console.log('======================================\n');

  let success = false;

  try {
    // 1. Setup
    console.log('1. Spawning test agent...');
    await mkdir(TEST_DIR, { recursive: true });

    const agentPrompt = `Write 'Test output from agent' to ${TEST_FILE} and confirm completion`;
    const { pid, process: proc } = spawnAgent(agentPrompt, {
      outputFile: TEST_FILE,
      cwd: projectRoot,
    });
    console.log(`   Agent spawned with PID ${pid}`);

    // 2. Wait for completion
    console.log('2. Waiting for completion...');
    const results = await waitForAgents([{ pid, process: proc, outputFile: TEST_FILE }], {
      timeout: 60000, // 60 second timeout
    });
    const agentResult = results[0];
    console.log(`   Agent exited with code ${agentResult.exitCode}`);

    // 3. Verify outputs
    console.log('3. Verifying outputs...');
    const verifications = await verifyOutputs([TEST_FILE]);
    const { report } = reportResults(verifications);
    console.log(`   ${report.split('\n').join('\n   ')}`);

    // 4. Collect content
    console.log('4. Collecting content...');
    const outputs = await collectOutputs([TEST_FILE]);
    const collected = outputs.filter((o) => o.content !== null);
    console.log(`   Collected ${collected.length} files`);
    if (collected.length > 0) {
      console.log(`   Content preview: "${collected[0].content.slice(0, 50)}..."`);
    }

    // 5. Cleanup
    console.log('5. Cleanup...');
    await rm(TEST_DIR, { recursive: true, force: true });
    console.log('   Test directory removed');

    // Determine result
    success = agentResult.success && collected.length > 0;
    console.log(`\nResult: ${success ? 'PASS' : 'FAIL'}`);
  } catch (err) {
    console.error(`\nError: ${err.message}`);
    console.log('\nResult: FAIL');

    // Cleanup on error
    try {
      await rm(TEST_DIR, { recursive: true, force: true });
    } catch {
      // Ignore cleanup errors
    }
  }

  return success;
}

/**
 * Main entry point
 */
async function main() {
  const hasCline = checkClineCli();

  if (hasCline) {
    const success = await runFullTest();
    process.exit(success ? 0 : 1);
  } else {
    const success = await runMockTest();
    process.exit(success ? 0 : 1);
  }
}

main().catch((err) => {
  console.error('Fatal error:', err);
  process.exit(1);
});
