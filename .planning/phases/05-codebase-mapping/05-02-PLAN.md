---
phase: 05-codebase-mapping
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - scripts/test-map-codebase.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Integration test validates buildMapperPrompts produces 4 prompts with correct focus areas"
    - "Integration test validates getExpectedOutputFiles returns 7 file paths"
    - "Integration test validates the verify -> report pipeline with mock files"
    - "Integration test handles partial failures (some files missing)"
    - "Test runs in tmpdir isolation with cleanup in finally block"
    - "package.json has test:map-codebase script"
  artifacts:
    - path: "scripts/test-map-codebase.js"
      provides: "Integration test for map-codebase.js module"
      contains: "buildMapperPrompts"
    - path: "package.json"
      provides: "Updated with test:map-codebase script"
      contains: "test:map-codebase"
  key_links:
    - from: "scripts/test-map-codebase.js"
      to: "src/map-codebase.js"
      via: "imports buildMapperPrompts, getExpectedOutputFiles, runMapping"
      pattern: "map-codebase"
    - from: "scripts/test-map-codebase.js"
      to: "src/agent-collect.js"
      via: "imports verifyOutputs, reportResults for pipeline validation"
      pattern: "verifyOutputs|reportResults"
---

<objective>
Create the integration test for the codebase mapping module and register it in package.json.

Purpose: Validate that the mapper orchestration module works correctly -- prompt construction, file path generation, and the verify/report pipeline -- without requiring the Cline CLI to be installed.

Output: `scripts/test-map-codebase.js` (integration test) and updated `package.json` (test script)
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-codebase-mapping/05-RESEARCH.md
@.planning/phases/05-codebase-mapping/05-01-SUMMARY.md

@src/map-codebase.js
@src/agent-collect.js
@scripts/test-project-init.js
@scripts/test-agent-infra.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test for map-codebase.js</name>
  <files>scripts/test-map-codebase.js</files>
  <action>
Create `scripts/test-map-codebase.js` following the established integration test pattern from `scripts/test-project-init.js` (tmpdir isolation, assert/strict, PASS/FAIL output, cleanup in finally block).

**Imports:**
```javascript
import { tmpdir } from 'node:os';
import { mkdir, rm, writeFile } from 'node:fs/promises';
import path from 'node:path';
import assert from 'node:assert/strict';

import { buildMapperPrompts, getExpectedOutputFiles } from '../src/map-codebase.js';
import { verifyOutputs, reportResults } from '../src/agent-collect.js';
```

**Test infrastructure** (copy pattern from test-project-init.js):
```javascript
let passed = 0;
let failed = 0;
const failures = [];

async function test(name, fn) {
  try {
    await fn();
    passed++;
    console.log(`  PASS  ${name}`);
  } catch (err) {
    failed++;
    failures.push({ name, error: err.message });
    console.log(`  FAIL  ${name}`);
    console.log(`        ${err.message}`);
  }
}
```

**Test cases:**

**--- buildMapperPrompts ---**

1. **Produces 4 prompts**: Call `buildMapperPrompts('/tmp/test')`. Assert `result.success === true`. Assert `result.data.length === 4`. Assert each item has `prompt`, `outputFile`, `focus` properties.

2. **Correct focus areas**: Extract focus values from result.data. Assert the set equals `['tech', 'arch', 'quality', 'concerns']` (order may vary, so sort both arrays before comparing).

3. **Prompts reference agent definition**: Assert every prompt string contains `'gsd-codebase-mapper.md'`.

4. **Prompts include output file paths**: For the tech focus area prompt, assert it contains `'STACK.md'` and `'INTEGRATIONS.md'`. For the concerns focus area prompt, assert it contains `'CONCERNS.md'`.

**--- getExpectedOutputFiles ---**

5. **Returns 7 file paths**: Call `getExpectedOutputFiles('/tmp/test/.planning')`. Assert `result.success === true`. Assert `result.data.length === 7`.

6. **Correct file names**: Extract basenames from all paths. Assert the sorted array equals `['ARCHITECTURE.md', 'CONCERNS.md', 'CONVENTIONS.md', 'INTEGRATIONS.md', 'STACK.md', 'STRUCTURE.md', 'TESTING.md']`.

7. **Paths include codebase directory**: Assert every path includes `/codebase/`.

**--- Verify/report pipeline with mock files ---**

8. **Full pipeline with all files present**: Create a temp directory with `.planning/codebase/`. Write all 7 mock files (each with 25+ lines of placeholder content). Call `getExpectedOutputFiles` with the temp planning dir. Call `verifyOutputs` on those paths. Call `reportResults` on the verifications. Assert `report.found === 7` and `report.missing === 0`. Assert `report.report` contains "OK" for each file.

9. **Partial failure (some files missing)**: Create a temp directory with `.planning/codebase/`. Write only STACK.md and ARCHITECTURE.md (not all 7). Call `verifyOutputs` on all 7 expected paths. Call `reportResults`. Assert `report.found === 2` and `report.missing === 5`. Assert the report string contains "MISSING" for the absent files.

10. **Empty directory (all files missing)**: Create a temp directory with `.planning/codebase/` but write no files. Call `verifyOutputs` on all 7 expected paths. Assert all verifications show `exists: false`. Call `reportResults`. Assert `report.found === 0` and `report.missing === 7`.

**Helper for mock file creation:**
```javascript
function generateMockContent(docName, lineCount = 30) {
  const lines = [`# ${docName}`, '', `Generated for testing at ${new Date().toISOString()}`, ''];
  for (let i = 0; i < lineCount - 4; i++) {
    lines.push(`Line ${i + 1}: Placeholder content for ${docName}`);
  }
  return lines.join('\n');
}
```

**Structure:**
- Create a unique temp dir: `path.join(tmpdir(), 'cline-gsd-map-test-' + Date.now())`
- Wrap all tests in try/finally with cleanup: `await rm(TEMP_DIR, { recursive: true, force: true })`
- Print summary at end: `N/M tests passed`
- Exit with code 1 if any failures, 0 if all pass

**Do NOT test `runMapping`** -- that function spawns real processes via `spawnAgent()`. The integration test validates the orchestration components (prompts, file paths, verification) in isolation. A separate test with Cline CLI would test the full pipeline.
  </action>
  <verify>
Run: `node scripts/test-map-codebase.js` from project root.

Expected output:
```
Map Codebase Integration Test
==============================

--- buildMapperPrompts ---
  PASS  1. Produces 4 prompts
  PASS  2. Correct focus areas
  PASS  3. Prompts reference agent definition
  PASS  4. Prompts include output file paths

--- getExpectedOutputFiles ---
  PASS  5. Returns 7 file paths
  PASS  6. Correct file names
  PASS  7. Paths include codebase directory

--- Verify/report pipeline ---
  PASS  8. Full pipeline with all files present
  PASS  9. Partial failure (some files missing)
  PASS  10. Empty directory (all files missing)

--- Cleanup ---
  Removed: /tmp/cline-gsd-map-test-...

========================================
10/10 tests passed
```

Exit code should be 0.
  </verify>
  <done>
`scripts/test-map-codebase.js` exists with 10 test cases covering buildMapperPrompts (4 tests), getExpectedOutputFiles (3 tests), and verify/report pipeline with mock files (3 tests). All tests pass with exit code 0. Tests use tmpdir isolation and cleanup in finally block.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test:map-codebase script to package.json</name>
  <files>package.json</files>
  <action>
Add the test:map-codebase npm script to the scripts section of `package.json`.

Read the current package.json and add this entry to the `scripts` object:
```json
"test:map-codebase": "node scripts/test-map-codebase.js"
```

Place it after the existing test scripts (test:agents, test:state, test:project-init) to maintain alphabetical/logical ordering.

The final scripts section should look like:
```json
"scripts": {
  "test:agents": "node scripts/test-agent-infra.js",
  "test:map-codebase": "node scripts/test-map-codebase.js",
  "test:project-init": "node scripts/test-project-init.js",
  "test:state": "node scripts/test-state.js"
}
```

(Alphabetically ordered by script name.)
  </action>
  <verify>
1. `grep 'test:map-codebase' package.json` -- should show the script entry
2. `node -e "const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf-8')); console.log(pkg.scripts['test:map-codebase'])"` -- should print `node scripts/test-map-codebase.js`
  </verify>
  <done>
`package.json` has `test:map-codebase` script pointing to `scripts/test-map-codebase.js`. Script is alphabetically ordered among existing test scripts.
  </done>
</task>

</tasks>

<verification>
1. Integration test passes:
   ```bash
   node scripts/test-map-codebase.js
   ```
   Exit code should be 0, all 10 tests should pass.

2. npm script registered:
   ```bash
   grep 'test:map-codebase' package.json
   ```

3. Test can be run via npm:
   ```bash
   npm run test:map-codebase
   ```
</verification>

<success_criteria>
- `scripts/test-map-codebase.js` has 10 test cases covering prompt construction, file path generation, and verification pipeline
- Tests use tmpdir isolation and cleanup in finally block
- Tests validate partial failure scenarios (not just happy path)
- All tests pass with exit code 0
- `package.json` has `test:map-codebase` script
- No Cline CLI required to run the test (pure module/function testing)
</success_criteria>

<output>
After completion, create `.planning/phases/05-codebase-mapping/05-02-SUMMARY.md`
</output>
