---
phase: 05-codebase-mapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/map-codebase.js
  - workflows/gsd/gsd-map-codebase.md
autonomous: true

must_haves:
  truths:
    - "buildMapperPrompts returns 4 prompt objects covering tech, arch, quality, concerns focus areas"
    - "Each prompt references agents/gsd-codebase-mapper.md and specifies correct output files"
    - "runMapping orchestrates spawn -> wait -> verify -> report pipeline"
    - "getExpectedOutputFiles returns all 7 expected codebase document paths"
    - "Sequential fallback works when parallelization=false"
    - "/gsd-map-codebase.md workflow guides Cline through the full mapping flow"
  artifacts:
    - path: "src/map-codebase.js"
      provides: "Mapper orchestration: prompt construction, pipeline execution, file path listing"
      exports: ["buildMapperPrompts", "runMapping", "getExpectedOutputFiles"]
    - path: "workflows/gsd/gsd-map-codebase.md"
      provides: "Cline workflow for /gsd-map-codebase command"
      contains: "gsd-map-codebase"
  key_links:
    - from: "src/map-codebase.js"
      to: "src/agent-spawn.js"
      via: "imports spawnAgent, spawnAgents, waitForAgents"
      pattern: "spawnAgent|spawnAgents|waitForAgents"
    - from: "src/map-codebase.js"
      to: "src/agent-collect.js"
      via: "imports verifyOutputs, reportResults"
      pattern: "verifyOutputs|reportResults"
    - from: "src/map-codebase.js"
      to: "agents/gsd-codebase-mapper.md"
      via: "prompts reference agent definition file for mapper instructions"
      pattern: "gsd-codebase-mapper"
    - from: "workflows/gsd/gsd-map-codebase.md"
      to: "src/map-codebase.js"
      via: "workflow invokes module functions via node -e"
      pattern: "map-codebase"
---

<objective>
Create the mapper orchestration module and Cline workflow for codebase mapping.

Purpose: Enable users to analyze existing codebases by spawning parallel mapper agents that produce 7 structured documents in `.planning/codebase/`. This is the first consumer of the agent infrastructure built in Phase 2.

Output: `src/map-codebase.js` (Node.js orchestration module) and `workflows/gsd/gsd-map-codebase.md` (Cline workflow)
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-codebase-mapping/05-RESEARCH.md

@src/agent-spawn.js
@src/agent-collect.js
@src/state-read.js
@src/output.js
@workflows/gsd/gsd-new-project.md
@workflows/gsd/gsd-progress.md
@agents/gsd-codebase-mapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/map-codebase.js orchestration module</name>
  <files>src/map-codebase.js</files>
  <action>
Create `src/map-codebase.js` -- an ESM module that coordinates the codebase mapping pipeline. This module is the bridge between the Cline workflow and the Phase 2 agent infrastructure.

**Imports:**
```javascript
import path from 'node:path';
import { mkdir } from 'node:fs/promises';
import { spawnAgent, spawnAgents, waitForAgents } from './agent-spawn.js';
import { verifyOutputs, reportResults } from './agent-collect.js';
import { readPlanningConfig } from './state-read.js';
```

**Constants:**

Define the 4 focus areas and their output files:
```javascript
const FOCUS_AREAS = [
  { focus: 'tech', files: ['STACK.md', 'INTEGRATIONS.md'] },
  { focus: 'arch', files: ['ARCHITECTURE.md', 'STRUCTURE.md'] },
  { focus: 'quality', files: ['CONVENTIONS.md', 'TESTING.md'] },
  { focus: 'concerns', files: ['CONCERNS.md'] },
];
```

**Function 1: `getExpectedOutputFiles(planningDir)`**
- Takes the `.planning/` directory path
- Returns an array of 7 absolute file paths: `planningDir/codebase/STACK.md`, `planningDir/codebase/INTEGRATIONS.md`, etc.
- Simply maps FOCUS_AREAS to full paths using `path.join(planningDir, 'codebase', file)`
- Returns `{ success: true, data: files }` following the error-return pattern

**Function 2: `buildMapperPrompts(cwd)`**
- Takes the project working directory (cwd)
- Returns `{ success: true, data: prompts }` where prompts is an array of 4 objects:
  ```
  { prompt: string, outputFile: string, focus: string }
  ```
- Each prompt should be constructed as follows (one per focus area):
  ```
  You are a codebase mapper agent.

  Read the agent definition at agents/gsd-codebase-mapper.md and follow the instructions for the "${focus}" focus area.

  Your focus area: ${focus}
  Write your output documents to:
  ${outputFiles.map(f => `- ${f}`).join('\n')}

  After writing, output a brief confirmation with file paths and line counts.
  ```
- The `outputFile` field in each prompt object should be the FIRST output file for that focus area (used by `spawnAgents` to append the "Write your output to:" instruction -- but since we already include output paths in the prompt body, set `outputFile` to the confirmation output path: `.planning/codebase/.mapper-${focus}-done.txt`)
- The `cwd` is passed through for agent spawning

**Function 3: `runMapping(projectRoot, options = {})`**
- This is the main pipeline function that orchestrates the full flow
- Parameters:
  - `projectRoot` - project root directory
  - `options.timeout` - per-agent timeout in ms (default: 300000 = 5 min)
  - `options.parallel` - whether to run agents in parallel (default: true)
- Flow:
  1. Compute `planningDir = path.join(projectRoot, '.planning')`
  2. Create output directory: `await mkdir(path.join(planningDir, 'codebase'), { recursive: true })`
  3. Build prompts: `const { data: prompts } = buildMapperPrompts(projectRoot)`
  4. **If parallel (default):**
     - Spawn all 4 agents at once using `spawnAgents(prompts.map(p => ({ prompt: p.prompt, outputFile: p.outputFile, timeout: options.timeout, cwd: projectRoot })))`
     - Wait: `const results = await waitForAgents(spawned, { timeout: options.timeout })`
  5. **If sequential (parallelization=false):**
     - Loop through prompts one at a time:
       - `const agent = spawnAgent(prompt.prompt, { outputFile: prompt.outputFile, timeout: options.timeout, cwd: projectRoot })`
       - `const [result] = await waitForAgents([{ ...agent, outputFile: prompt.outputFile }], { timeout: options.timeout })`
  6. Get expected files: `const { data: expectedFiles } = getExpectedOutputFiles(planningDir)`
  7. Verify outputs: `const verifications = await verifyOutputs(expectedFiles)`
  8. Generate report: `const report = reportResults(verifications)`
  9. Return:
     ```javascript
     return {
       success: report.found > 0,
       data: {
         report: report.report,
         total: report.total,
         found: report.found,
         missing: report.missing,
         verifications,
       },
     };
     ```
  10. Wrap entire function in try/catch, return `{ success: false, error: err.message }` on failure

**Error-return pattern:** All three functions return `{ success, data, error }` per project convention. No throwing.

**Do NOT import output.js.** This module is pure logic/orchestration -- terminal output is handled by the workflow or the caller.
  </action>
  <verify>
1. `node -e "import('./src/map-codebase.js').then(m => console.log('Exports:', Object.keys(m)))"` -- should print: `Exports: [ 'getExpectedOutputFiles', 'buildMapperPrompts', 'runMapping' ]` (order may vary)
2. `node -e "import('./src/map-codebase.js').then(m => { const r = m.getExpectedOutputFiles('/tmp/test/.planning'); console.log(r.data.length, 'files'); console.log(r.data.map(f => f.split('/').pop()).join(', ')); })"` -- should print 7 files: STACK.md, INTEGRATIONS.md, ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md
3. `node -e "import('./src/map-codebase.js').then(m => { const r = m.buildMapperPrompts('/tmp/test'); console.log(r.data.length, 'prompts'); r.data.forEach(p => console.log(p.focus)); })"` -- should print 4 prompts with focus areas: tech, arch, quality, concerns
4. Verify each prompt contains "gsd-codebase-mapper.md": `node -e "import('./src/map-codebase.js').then(m => { const r = m.buildMapperPrompts('/tmp/test'); const all = r.data.every(p => p.prompt.includes('gsd-codebase-mapper')); console.log('References agent file:', all); })"`
  </verify>
  <done>
`src/map-codebase.js` exports `getExpectedOutputFiles`, `buildMapperPrompts`, and `runMapping`. The module constructs 4 mapper prompts (tech, arch, quality, concerns) that reference `agents/gsd-codebase-mapper.md`, and orchestrates the spawn -> wait -> verify -> report pipeline using existing Phase 2 infrastructure. Supports both parallel and sequential modes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gsd-map-codebase.md Cline workflow</name>
  <files>workflows/gsd/gsd-map-codebase.md</files>
  <action>
Create `workflows/gsd/gsd-map-codebase.md` -- a Cline workflow file that users invoke with `/gsd-map-codebase.md` to map an existing codebase. Follow the same format as `workflows/gsd/gsd-new-project.md` and `workflows/gsd/gsd-progress.md`.

**Frontmatter:**
```yaml
---
description: Analyze existing codebase with parallel mapper agents
---
```

**Title:**
```markdown
# /gsd-map-codebase.md - Map Existing Codebase
```

**Intro paragraph:**
You are mapping an existing codebase to produce structured documentation that downstream GSD commands will use for planning and execution. This spawns parallel mapper agents, each analyzing a different aspect of the codebase.

**Step 1: Check for existing codebase map**
- Check: `ls .planning/codebase/*.md 2>/dev/null | wc -l`
- If files exist, inform the user: "A codebase map already exists with N documents. Options: (1) Refresh -- delete and re-map from scratch, (2) Skip -- keep existing map. Which would you prefer?"
- If user says refresh: `rm -rf .planning/codebase && mkdir -p .planning/codebase`
- If user says skip: Stop and suggest `/gsd-progress.md`
- If no existing map: continue to next step

**Step 2: Verify prerequisites**
- Check `.planning/` exists: `test -d .planning && echo "exists" || echo "missing"`
- If missing: Create it: `mkdir -p .planning .planning/phases`
- Check `agents/gsd-codebase-mapper.md` exists: `test -f agents/gsd-codebase-mapper.md && echo "exists" || echo "missing"`
- If agent file missing: Error -- "The mapper agent definition is missing. Ensure you have the full cline-gsd installation. Re-run `npx cline-gsd` to reinstall."
- Create output directory: `mkdir -p .planning/codebase`

**Step 3: Read configuration**
- Read config for parallelization and commit_docs settings:
  ```bash
  node -e "
  import { readPlanningConfig } from './src/state-read.js';
  const result = await readPlanningConfig('.planning');
  console.log(JSON.stringify({ parallel: result.data.parallelization, commit_docs: result.data.commit_docs }));
  "
  ```
- Store these values for use in subsequent steps

**Step 4: Spawn mapper agents**
- Use the orchestration module to run the mapping:
  ```bash
  node -e "
  import { runMapping } from './src/map-codebase.js';
  const result = await runMapping(process.cwd(), { parallel: PARALLEL_VALUE });
  console.log(JSON.stringify(result, null, 2));
  "
  ```
  Replace `PARALLEL_VALUE` with the value from Step 3.
- Inform the user that 4 mapper agents are being spawned:
  - Agent 1 (tech): Analyzing technology stack and integrations
  - Agent 2 (arch): Analyzing architecture and structure
  - Agent 3 (quality): Analyzing conventions and testing
  - Agent 4 (concerns): Analyzing tech debt and concerns
- Note: This step may take 2-5 minutes depending on codebase size

**Step 5: Verify results**
- Check the output from runMapping:
  - If `success: true` and all 7 files found: Proceed to commit
  - If `success: true` but some files missing: Report which files were produced and which are missing. Ask user: "N of 7 documents were produced. Would you like to re-run the failed mappers or continue with partial results?"
  - If `success: false`: Report the error. Suggest re-running the workflow.
- For each produced file, verify it has >20 lines:
  ```bash
  for f in .planning/codebase/*.md; do
    lines=$(wc -l < "$f" 2>/dev/null || echo 0)
    name=$(basename "$f")
    if [ "$lines" -gt 20 ]; then
      echo "OK: $name ($lines lines)"
    else
      echo "WARN: $name only has $lines lines (may be incomplete)"
    fi
  done
  ```

**Step 6: Commit codebase map**
- Only if commit_docs is true (from Step 3):
  ```bash
  git add .planning/codebase/*.md && git commit -m "docs: map existing codebase via /gsd-map-codebase"
  ```
- If commit_docs is false: Skip with a note: "Skipping git commit (commit_docs: false in config)"

**Step 7: Present results and next steps**
- Show a summary:
  ```
  ## Codebase Map Complete

  | Document | Lines | Status |
  |----------|-------|--------|
  | STACK.md | N | OK |
  | INTEGRATIONS.md | N | OK |
  | ARCHITECTURE.md | N | OK |
  | STRUCTURE.md | N | OK |
  | CONVENTIONS.md | N | OK |
  | TESTING.md | N | OK |
  | CONCERNS.md | N | OK |

  These documents will be automatically loaded by downstream GSD commands
  (/gsd-plan-phase, /gsd-execute-phase) based on phase type.

  ## What's Next

  Run `/gsd-new-project.md` to set up the project, or `/gsd-progress.md` to check status.
  ```

**Behavioral guidelines:**
- Inform user when agents are spawning (they may take a few minutes)
- Handle errors gracefully -- partial results are better than no results
- Do not read the content of produced documents (they are for downstream commands)
- Keep the workflow concise; the orchestration module does the heavy lifting
- Target ~120-160 lines for the workflow file
  </action>
  <verify>
1. `test -f workflows/gsd/gsd-map-codebase.md && echo "exists"` -- should print "exists"
2. `head -3 workflows/gsd/gsd-map-codebase.md` -- should show `---`, `description:`, `---`
3. `grep -c 'Step' workflows/gsd/gsd-map-codebase.md` -- should show 7 steps
4. `grep -q 'map-codebase' workflows/gsd/gsd-map-codebase.md && echo "references module"` -- should pass
5. `grep -q 'gsd-codebase-mapper' workflows/gsd/gsd-map-codebase.md && echo "references agent"` -- should pass
6. `grep -q 'commit' workflows/gsd/gsd-map-codebase.md && echo "has commit step"` -- should pass
7. `wc -l workflows/gsd/gsd-map-codebase.md` -- should be approximately 120-160 lines
  </verify>
  <done>
`workflows/gsd/gsd-map-codebase.md` exists with YAML frontmatter, 7-step flow (check existing, prerequisites, config, spawn, verify, commit, results), references `src/map-codebase.js` for orchestration and `agents/gsd-codebase-mapper.md` for agent instructions, handles partial failures gracefully, and commits results when commit_docs is enabled.
  </done>
</task>

</tasks>

<verification>
1. Module loads cleanly:
   ```bash
   node -e "import('./src/map-codebase.js').then(() => console.log('Module loads OK'))"
   ```

2. Workflow exists with frontmatter:
   ```bash
   test -f workflows/gsd/gsd-map-codebase.md && head -3 workflows/gsd/gsd-map-codebase.md
   ```

3. Module exports all 3 functions:
   ```bash
   node -e "import('./src/map-codebase.js').then(m => console.log(Object.keys(m).sort().join(', ')))"
   ```
   Expected: `buildMapperPrompts, getExpectedOutputFiles, runMapping`

4. Prompt construction produces 4 prompts with correct focus areas:
   ```bash
   node -e "import('./src/map-codebase.js').then(m => { const r = m.buildMapperPrompts('/tmp'); r.data.forEach(p => console.log(p.focus)); })"
   ```

5. Expected files list has 7 entries:
   ```bash
   node -e "import('./src/map-codebase.js').then(m => { const r = m.getExpectedOutputFiles('/tmp/.planning'); console.log(r.data.length); })"
   ```
</verification>

<success_criteria>
- `src/map-codebase.js` exports buildMapperPrompts, runMapping, getExpectedOutputFiles
- buildMapperPrompts produces 4 prompts referencing the upstream agent definition
- runMapping uses spawnAgents/waitForAgents from Phase 2 infrastructure
- runMapping supports both parallel and sequential execution modes
- getExpectedOutputFiles returns all 7 codebase document paths
- All functions follow error-return pattern (no throwing)
- `workflows/gsd/gsd-map-codebase.md` guides users through the full mapping flow
- Workflow handles existing maps (refresh/skip), partial failures, and commit settings
</success_criteria>

<output>
After completion, create `.planning/phases/05-codebase-mapping/05-01-SUMMARY.md`
</output>
