---
phase: 04-new-project-workflow
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - workflows/gsd/gsd-progress.md
  - scripts/test-project-init.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "/gsd-progress.md shows current project state with visual progress bar"
    - "/gsd-progress.md suggests the correct next action based on project state"
    - "/gsd-progress.md handles missing .planning/ gracefully with guidance"
    - "project-init.js functions pass integration tests"
  artifacts:
    - path: "workflows/gsd/gsd-progress.md"
      provides: "Progress check and smart routing workflow"
      contains: "gsd-progress"
    - path: "scripts/test-project-init.js"
      provides: "Integration test for project-init.js"
      contains: "writeProjectMd"
  key_links:
    - from: "workflows/gsd/gsd-progress.md"
      to: ".planning/STATE.md"
      via: "reads state files for status display"
      pattern: "STATE.md"
    - from: "workflows/gsd/gsd-progress.md"
      to: ".planning/ROADMAP.md"
      via: "reads roadmap for phase progress"
      pattern: "ROADMAP.md"
---

<objective>
Create the progress workflow and integration test for project initialization.

Purpose: Enable users to check project status via `/gsd-progress.md` with smart routing to the next action, and verify the project-init helper functions work end-to-end.

Output: `workflows/gsd/gsd-progress.md` (Cline workflow) and `scripts/test-project-init.js` (integration test)
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-new-project-workflow/04-RESEARCH.md

@src/state-read.js
@src/state-init.js
@workflows/gsd/gsd-health.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-progress.md workflow</name>
  <files>workflows/gsd/gsd-progress.md</files>
  <action>
Create `workflows/gsd/gsd-progress.md` -- a Cline workflow file for checking project progress and routing to the next action. This is the session resumption mechanism: when a user opens a new Cline session, they type `/gsd-progress.md` to pick up where they left off.

**Structure:**

```yaml
---
description: Check project progress and suggest next action
---
```

**Steps:**

**Step 1: Verify planning structure**
- Check if `.planning/` directory exists: `test -d .planning && echo "exists" || echo "missing"`
- If missing, display: "No GSD project found in this directory. Run `/gsd-new-project.md` to initialize a new project."
- Stop here if missing.

**Step 2: Load project context**
- Read these files (skip any that don't exist, don't error):
  - `.planning/PROJECT.md` -- project name and core value
  - `.planning/STATE.md` -- current position, progress, session continuity
  - `.planning/ROADMAP.md` -- phase progress table, plan checkboxes
  - `.planning/config.json` -- workflow preferences
- Parse the project name from the `# ` heading in PROJECT.md
- Parse current position from STATE.md (Phase N of M, Plan X of Y, Status)
- Parse the progress table from ROADMAP.md (completed/total per phase)

**Step 3: Present status report**
- Display a formatted status report:

```
# [Project Name]

**Core Value:** [core value from PROJECT.md]

**Progress:** [progress bar] N/M plans complete (X%)

## Current Position
Phase N of M: [phase-name]
Plan: X of Y in current phase
Status: [status]
Last activity: [timestamp] -- [description]

## Phase Progress
| Phase | Status | Progress |
|-------|--------|----------|
| 1. [name] | Complete | 3/3 |
| 2. [name] | In progress | 1/2 |
| ... | ... | ... |

## Session Info
Last session: [date]
Stopped at: [description]
```

**Step 4: Smart routing -- suggest next action**
- Based on the current state, suggest ONE clear next action:

| Condition | Suggestion |
|-----------|------------|
| No ROADMAP.md exists | "Run `/gsd-new-project.md` to complete project setup" |
| Current phase has unplanned work (Plans: TBD) | "Plan the next phase: Phase N needs planning" |
| Current phase has unexecuted plans | "Execute the current phase: run the next plan" |
| Current phase is complete | "Phase N is complete! Start planning Phase N+1" |
| All phases complete | "All phases complete! Consider running verification." |
| Status contains "blocked" or "error" | "There's a blocker. Check STATE.md for details." |

- Present the suggestion as a clear, actionable instruction with the exact command to run
- If the next action is a GSD workflow, provide the `/gsd-xxx.md` command

**Behavioral instructions:**
- Be concise -- this is a status check, not a conversation
- Read files silently (don't narrate "I'm reading STATE.md...")
- Present the report in a single, well-formatted message
- If any state file is missing or malformed, note it but don't crash -- provide what information is available
- The progress bar should use block characters: [████░░░░░░] format
- Calculate overall progress as: (total completed plans across all phases) / (total plans across all phases)

Keep the workflow to approximately 80-120 lines. It should be shorter than the new-project workflow since it's a read-only status check.
  </action>
  <verify>
1. `test -f workflows/gsd/gsd-progress.md && echo "exists"` -- should print "exists"
2. `head -3 workflows/gsd/gsd-progress.md` -- should show `---`, `description:`, `---`
3. Verify routing table is present: grep for "gsd-new-project" (the fallback suggestion)
4. Verify state file reading: grep for "STATE.md" and "ROADMAP.md"
5. Verify progress bar instruction: grep for "progress" in the workflow
6. Verify graceful handling: grep for "missing" or "don't exist"
  </verify>
  <done>
`workflows/gsd/gsd-progress.md` exists with YAML frontmatter, reads all state files gracefully, presents a formatted status report with progress bar, and provides smart routing to the next action based on project state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration test for project-init.js</name>
  <files>scripts/test-project-init.js</files>
  <action>
Create `scripts/test-project-init.js` following the same pattern as `scripts/test-state.js` (the existing integration test). This test validates both `writeProjectMd` and `writeConfigJson` from `src/project-init.js`.

**Test structure:**
- Use a temp directory (`mkdtemp`) for isolation
- Clean up temp directory in a finally block
- Print test name and PASS/FAIL for each assertion
- Exit with code 1 if any test fails, 0 if all pass
- Use picocolors for colored output (green PASS, red FAIL) matching test-state.js style

**Test cases for `writeProjectMd`:**

1. **Basic creation**: Call with name, description, coreValue, context, constraints. Verify file exists and contains all provided values.
2. **Requirements populated**: Call with `requirements: { validated: ['REQ-01: Auth'], active: ['REQ-02: API'], outOfScope: ['REQ-03: Mobile'] }`. Verify all three sections are populated.
3. **Key decisions populated**: Call with `keyDecisions: [{ decision: 'Use React', rationale: 'Team expertise', outcome: 'Adopted' }]`. Verify the table row appears.
4. **Error handling**: Call with an invalid path (e.g., `/nonexistent/deep/path/that/wont/exist`). Verify `success === false` and `error` is a string.
5. **Date defaulting**: Call without `date` field. Verify the file contains today's date in YYYY-MM-DD format.

**Test cases for `writeConfigJson`:**

6. **Defaults only**: Call with empty preferences `{}`. Verify file contains all default values (mode='yolo', depth='comprehensive', etc.).
7. **Scalar overrides**: Call with `{ mode: 'interactive', depth: 'quick' }`. Verify those are overridden but all other defaults remain.
8. **Nested object merge**: Call with `{ workflow: { research: false } }`. Verify `workflow.research === false` but `workflow.plan_check === true` and `workflow.verifier === true` (other nested defaults preserved).
9. **Error handling**: Call with invalid path. Verify `success === false`.

**Add npm script**: The test should also note in a comment that it can be added to package.json as `"test:project-init": "node scripts/test-project-init.js"` -- but do NOT modify package.json in this task (that's a shared file and Plan 01 might also touch it if needed).

Actually, DO add the npm script to package.json since Plan 01 does not modify it. Add `"test:project-init": "node scripts/test-project-init.js"` to the scripts section.
  </action>
  <verify>
Run: `node scripts/test-project-init.js` from project root. All test cases should print PASS. Exit code should be 0.

Note: This test depends on `src/project-init.js` from Plan 01. If Plan 01 hasn't executed yet, the import will fail. The test itself is correct -- it just needs its dependency. If running in Wave 1 parallel, the test execution verification happens after both plans complete.
  </verify>
  <done>
`scripts/test-project-init.js` exists with 9 test cases covering writeProjectMd (basic, requirements, key decisions, error handling, date default) and writeConfigJson (defaults, scalar overrides, nested merge, error handling). `package.json` has `test:project-init` script. All tests pass when `src/project-init.js` is available.
  </done>
</task>

</tasks>

<verification>
1. `test -f workflows/gsd/gsd-progress.md` -- workflow file exists
2. `grep 'description:' workflows/gsd/gsd-progress.md` -- has frontmatter
3. `node scripts/test-project-init.js` -- all tests pass (requires Plan 01 to have completed first)
4. `grep 'test:project-init' package.json` -- npm script registered
</verification>

<success_criteria>
- `workflows/gsd/gsd-progress.md` is a complete Cline workflow with state reading and smart routing
- `scripts/test-project-init.js` has 9 test cases covering both helper functions
- Integration test passes with exit code 0
- Progress workflow handles missing `.planning/` gracefully
- Progress workflow provides smart routing based on current state
</success_criteria>

<output>
After completion, create `.planning/phases/04-new-project-workflow/04-02-SUMMARY.md`
</output>
